generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id       Int    @id @default(autoincrement())
  name     String
  email    String @unique
  password String

  role        Role         @relation(fields: [roleId], references: [name])
  roleId      String
  permissions Permission[]

  bankName String? @default("")
  bankCode String? @default("")
  agency String? @default("")
  agencyDigit String? @default("")
  accountNumber String? @default("")
  accountDigit String? @default("")
  accountType String? @default("")

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  forgotAccessCodes ForgotAccessCode[]
  configurations Configuration[]
  userEvents UserEvents[]
  contracts Contract[]
  properties Property[]
}

model ForgotAccessCode {
  code String @id
  userId Int
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  expiresAt DateTime
  usedAt DateTime?
  used Boolean @default(false)
}

model Configuration {
  id Int @id @default(autoincrement())
  userId Int
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  name String
  value String

  @@index([name])
}

model UserEvents {
  id        Int    @id @default(autoincrement())
  userId    Int
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action String
  params String
  body String @db.VarChar(512)
  ip String
  userAgent String
  url String

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
}

model Role {
  name  String @id
  users User[]
  permissions Permission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Permission {
  name  String @id
  users User[]
  roles Role[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Property {
  id        Int    @id @default(autoincrement())
  externalId String
  name      String? @default("")
  cep       String? @default("")
  state     String? @default("")
  city      String? @default("")
  neighborhood String? @default("")
  street    String? @default("")
  number    String? @default("")
  complement String? @default("")

  condominium String? @default("")
  block     String? @default("")
  unity     String? @default("")
  condominiumValue Int? @default(0)
  iptuValue Int? @default(0)

  type PropertyType
  status PropertyStatus
  statusDate DateTime
  statusRegistry String

  alienatedBank String? @default("")
  alienationRegistry String? @default("")

  registryOffice String? @default("")
  registryOfficeCity String? @default("SÃ£o Paulo")
  registrationNumber String? @default("")
  registeredWithAnotherOwner Boolean @default(false)

  acquiredDate DateTime?
  acquiredRegistry String?

  taxPayerNumber String? @default("")
  taxPayerName String? @default("")

  area String? @default("")
  parkingSpaces String? @default("")
  floorLevel String? @default("")

  electricityRegistration String? @default("")
  waterRegistration String? @default("")
  isWaterIndividual Boolean @default(true)
  gasRegistration String? @default("")
  isGasIndividual Boolean @default(true)

  observations String? @default("")

  referrerId Int
  referrer User @relation(fields: [referrerId], references: [id], onDelete: Cascade)

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  Contract Contract[]
}

enum PropertyType {
  HOUSE
  APARTMENT
  CONDOMINIUM_HOUSE
}

enum PropertyStatus {
  FINANCED
  PAID_OFF
}

model Contract {
  id Int @id @default(autoincrement())
  propertyId Int 
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  ownerCode String @unique
  acquirerCode String @unique

  value Float

  parties Party[]
  realtors User[]

  status ContractStatus @default(PENDING)
  type ContractType

  attachedDocuments Document[]

  guaranteeType String? @default("")
  leaseStartDate DateTime?
  leaseEndDate DateTime?
  rentDueDay Int?

  bankName String? @default("")
  bankCode String? @default("")
  agency String? @default("")
  agencyDigit String? @default("")
  accountNumber String? @default("")
  accountDigit String? @default("")
  accountType String? @default("")

  pixType PixType? @default(CPF)
  pixKey String? @default("")

  whoWillPayComission PartyType @default(OWNER)

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  paymentInstallments PaymentInstallments[]
  checklistTitles ChecklistTitle[]

  witnesses Witness[]
}

enum PixType {
  CPF
  CNPJ
  EMAIL
  PHONE
  RANDOM
}

enum ContractStatus {
  PENDING
  BLOCKED
  IN_PROGRESS
  SIGNED
}

enum ContractType {
  SALE
  LEASE
}

model PaymentInstallments {
  id Int @id @default(autoincrement())
  type PaymentInstallmentsType
  contractId Int
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  value Float
  dueDate DateTime
  paid Boolean @default(false)
  paidAt DateTime?

  bankName String? @default("")
  bankCode String? @default("")
  agency String? @default("")
  agencyDigit String? @default("")
  accountNumber String? @default("")
  accountDigit String? @default("")
  accountType String? @default("")

  @@index([type, contractId])
}

enum PaymentInstallmentsType {
  SIGNAL
  DOCUMENTATION
  SIGNATURE
  FGTS
  FINANCEMENT
  COMISSION
}


model Party {
  id Int @id @default(autoincrement())
  code String
  type PartyType
  data PartyInfo[]

  contractId Int
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
}

enum PartyType {
  ACQUIRER
  OWNER
}

model PartyInfo {
  id Int @id @default(autoincrement())
  partyId Int
  party Party @relation(fields: [partyId], references: [id], onDelete: Cascade)

  key String
  value String
}

model Document {
  id Int @id @default(autoincrement())
  name String
  url String
  contractId Int
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PartyForm {
  type PartyFormType @id


  attributes PartyFormAttribute[]
}

enum PartyFormType {
  SELLERS
  BUYERS
  LANDLORDS
  TENANTS
}

model PartyFormAttribute {
  id Int @id @default(autoincrement())
  partyFormType PartyFormType
  partyForm PartyForm @relation(fields: [partyFormType], references: [type], onDelete: Cascade)
  
  name String
  type PartyFormAttributeType
  title String
  placeholder String
  required Boolean
  order Int
  regexFormat String?
  default String
  options String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PartyFormAttributeType {
  number
  float
  text
  radio
  checkbox
  tel
  date
  file
}

model ChecklistTitle {
  id Int @id @default(autoincrement())
  title String
  instructions String?
  checklistItems ChecklistItem[]

  contractId Int
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  order Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChecklistItem {
  id Int @id @default(autoincrement())
  checklistTitleId Int
  title String
  instructions String?
  checklistTitle ChecklistTitle @relation(fields: [checklistTitleId], references: [id], onDelete: Cascade)
  order Int

  checked Boolean
  checkedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Witness {
  id Int @id @default(autoincrement())
  name String
  rg String
  signature String? @default("")

  contracts Contract[]
}
